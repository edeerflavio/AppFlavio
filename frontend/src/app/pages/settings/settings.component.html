<div class="settings-page">

    <!-- ═══════════ Page Header ═══════════ -->
    <header class="page-header">
        <div class="page-title">
            <span class="material-symbols-rounded page-icon">settings</span>
            <div>
                <h1>Configurações</h1>
                <p>Personalize sua experiência no Medical Scribe.</p>
            </div>
        </div>
    </header>

    <!-- ═══════════ Loading State ═══════════ -->
    <div class="loading-overlay" *ngIf="loadingConfig">
        <span class="spinner"></span>
        <span>Carregando configurações...</span>
    </div>

    <!-- ═══════════ Error Banner ═══════════ -->
    <div class="alert alert-error" *ngIf="errorMessage">
        <span class="material-symbols-rounded">error</span>
        <span>{{ errorMessage }}</span>
        <button class="alert-dismiss" (click)="errorMessage = ''">
            <span class="material-symbols-rounded">close</span>
        </button>
    </div>

    <!-- ═══════════ Cards Layout ═══════════ -->
    <div class="cards-grid" *ngIf="!loadingConfig">

        <!-- ── Left Column: Perfil ── -->
        <section class="card">
            <div class="card-header">
                <div class="card-icon blue">
                    <span class="material-symbols-rounded">person</span>
                </div>
                <div>
                    <h2>Perfil do Médico</h2>
                    <p class="card-desc">Identificação nos documentos clínicos</p>
                </div>
            </div>

            <div class="card-body">
                <div class="field">
                    <label for="doctorName">Nome do Médico</label>
                    <input type="text" id="doctorName" [(ngModel)]="doctorName" placeholder="Ex: Dr. Flávio" />
                </div>

                <div class="info-box">
                    <span class="material-symbols-rounded">info</span>
                    <span>Este nome será usado para identificar o médico na transcrição e em todos os documentos
                        gerados.</span>
                </div>
            </div>
        </section>

        <!-- ── Right Column: IA ── -->
        <section class="card">
            <div class="card-header">
                <div class="card-icon emerald">
                    <span class="material-symbols-rounded">psychology</span>
                </div>
                <div>
                    <h2>Configuração de IA</h2>
                    <p class="card-desc">Provedor, modelos e credenciais</p>
                </div>
            </div>

            <div class="card-body">

                <!-- Provider -->
                <div class="field">
                    <label for="provider">Provedor</label>
                    <select id="provider" [(ngModel)]="provider">
                        <option value="openai">OpenAI</option>
                    </select>
                </div>

                <!-- API Key -->
                <div class="field">
                    <label for="apiKey">
                        API Key
                        <span class="badge badge-ok" *ngIf="hasApiKey && !apiKey">
                            <span class="material-symbols-rounded filled">check_circle</span>
                            {{ apiKeyMasked }}
                        </span>
                        <span class="badge badge-warn" *ngIf="!hasApiKey && !apiKey">
                            <span class="material-symbols-rounded">warning</span>
                            Não configurada
                        </span>
                    </label>
                    <div class="input-with-action">
                        <input [type]="showApiKey ? 'text' : 'password'" id="apiKey" [(ngModel)]="apiKey"
                            [placeholder]="hasApiKey ? 'Deixe em branco para manter a atual' : 'sk-proj-...'"
                            class="mono" />
                        <button class="btn-icon" (click)="toggleApiKeyVisibility()" type="button"
                            [title]="showApiKey ? 'Ocultar' : 'Mostrar'">
                            <span class="material-symbols-rounded">
                                {{ showApiKey ? 'visibility_off' : 'visibility' }}
                            </span>
                        </button>
                    </div>
                    <p class="field-help">
                        Obtenha sua chave em
                        <a href="https://platform.openai.com/api-keys" target="_blank"
                            rel="noopener">platform.openai.com</a>
                    </p>
                </div>

                <!-- Models -->
                <div class="field-row">
                    <div class="field">
                        <label for="transcriptionModel">Modelo de Transcrição</label>
                        <select id="transcriptionModel" [(ngModel)]="transcriptionModel">
                            <option *ngFor="let m of availableTranscriptionModels" [value]="m">{{ m }}</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="chatModel">Modelo de Chat</label>
                        <select id="chatModel" [(ngModel)]="chatModel">
                            <option *ngFor="let m of availableChatModels" [value]="m">{{ m }}</option>
                        </select>
                    </div>
                </div>

                <!-- Test Connection -->
                <div class="divider"></div>

                <div class="test-row">
                    <button class="btn-outline" (click)="testConnection()" [disabled]="testingConnection || !hasApiKey">
                        <span class="spinner-sm" *ngIf="testingConnection"></span>
                        <span class="material-symbols-rounded" *ngIf="!testingConnection">bolt</span>
                        {{ testingConnection ? 'Testando...' : 'Testar Conexão' }}
                    </button>

                    <div class="alert alert-inline alert-ok" *ngIf="connectionStatus === 'success'">
                        <span class="material-symbols-rounded filled">check_circle</span>
                        {{ connectionMessage }}
                    </div>
                    <div class="alert alert-inline alert-error" *ngIf="connectionStatus === 'error'">
                        <span class="material-symbols-rounded filled">cancel</span>
                        {{ connectionMessage }}
                    </div>
                </div>

            </div>
        </section>
    </div>

    <!-- ═══════════ Footer Actions ═══════════ -->
    <footer class="actions-bar" *ngIf="!loadingConfig">
        <button class="btn-ghost" (click)="resetSettings()">
            <span class="material-symbols-rounded">restart_alt</span>
            Restaurar Padrão
        </button>
        <button class="btn-primary" (click)="saveSettings()" [disabled]="saving">
            <span class="spinner-sm" *ngIf="saving"></span>
            <span class="material-symbols-rounded" *ngIf="!saving">save</span>
            {{ saving ? 'Salvando...' : 'Salvar Alterações' }}
        </button>
    </footer>

    <!-- ═══════════ Success Toast ═══════════ -->
    <div class="toast toast-success" *ngIf="saved">
        <span class="material-symbols-rounded filled">check_circle</span>
        Configurações salvas com sucesso!
    </div>
</div>